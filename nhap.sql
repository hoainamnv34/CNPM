--TAO DATABASE
CREATE DATABASE QLDT_VHNAM_20204502
GO
--TAO BANG
CREATE TABLE SINHVIEN_NAMVH (
MaSV_4592 VARCHAR(5) PRIMARY KEY,
HoTen_SV_4592 NVARCHAR(25) NOT NULL,
LOP_SV_4592 NVARCHAR(20) NOT NULL,
EMAIL_SV_4592 NVARCHAR(30) NOT NULL
)

CREATE TABLE HOCPHAN_NAMVH (
MaHP_4592 VARCHAR(6) PRIMARY KEY,
TenHP_4592 NVARCHAR(50) NOT NULL,
SOTCTL_4592 INT NOT NULL,
SoGioLT_4592 INT NOT NULL,
SoGioBT_4592 INT NOT NULL,
SoGioTH_4592 INT NOT NULL,
HeSoDiemCK REAL NOT NULL,
MACTDT_4592 VARCHAR(10) NOT NULL
)

CREATE TABLE CTDT_NAMVH(
MaCTDT_4592 VARCHAR(10) PRIMARY KEY,
TenCTDT_4592 NVARCHAR(50) NOT NULL,
SoTinChiCan_4592 INT NOT NULL,
KhoavienQL_4592 NVARCHAR(30) NOT NULL
)

CREATE TABLE DANGKY_NAMVH(
MaSV_4592 VARCHAR(5) NOT NULL,
MaHP_4592 VARCHAR(6) NOT NULL,
KYHOC_4592 VARCHAR(5) NOT NULL,
DIEMQT_4592 REAL NOT NULL,
DIEMCK_4592 REAL NOT NULL,
PRIMARY KEY(MASV_4592, MAHP_4592)
)


--TAO KHOA NGOAI
ALTER TABLE HOCPHAN_NAMVH
ADD FOREIGN KEY (MaCTDT_4592) REFERENCES CTDT_NAMVH(MaCTDT_4592)
ALTER TABLE DANGKY_NAMVH
ADD FOREIGN KEY (MaSV_4592) REFERENCES SINHVIEN_NAMVH(MaSV_4592)
ALTER TABLE DANGKY_NAMVH
ADD FOREIGN KEY (MaHP_4592) REFERENCES HOCPHAN_NAMVH(MaHP_4592)


--2.1
ALTER TABLE HOCPHAN_NAMVH
ADD check(HeSoDiemCK >=0.6)
ALTER TABLE DANGKY_NAMVH
ADD check(DIEMQT_4592 between 0 and 10)
ALTER TABLE DANGKY_NAMVH
ADD check(DIEMQT_4592 between 0 and 10) 

--2.2 
ALTER TABLE CTDT_NAMVH
ADD check(MaCTDT_4592 in ('ICT', 'VietNhat', 'KSCLC', 'SIE', 'KHMT', 'KTMT', 'ATTT', 'KSTN'))

-- 2.3
ALTER TABLE CTDT_NAMVH
ADD check(SoTinChiCan_4592 between 158 and 165)


--3 NHAP DU LIEU
INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV001', N'VU HONG HANH', N'KHMT01', N'hanhvh@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV002', N'LE THANH TUAN', N'KHMT01', N'tuanlt@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV003', N'NGUYEN VAN NAM', N'KHMT01', N'namnv@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV004', N'NGUYEN LAN HUONG', N'KHMT01', N'huongnl@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV005', N'DINH THU HANG', N'KHMT02', N'hangtd@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV006', N'TRAN NAM ANH', N'KHMT02', N'anhtn@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV007', N'LE VAN DONG', N'KHMT02', N'donglv@gmail.com')

INSERT INTO SINHVIEN_NAMVH(MaSV_4592, HoTen_SV_4592, LOP_SV_4592, EMAIL_SV_4592)
VALUES ('SV008', N'NGUYEN THI THU', N'KHMT02', N'thunt@gmail.com')


INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('ATTT', N'AN TOAN', 158, N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('ICT', N'TIENGANH',165 , N'Ngoai Ngu')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('KHMT', N'KHOA HOC', 158, N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('KSCLC', N'CL CAO',165 , N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('KSTN', N'TAINANG',165 , N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('KTMT', N'KY THUAT',158 , N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('SIE', N'HOP TAC',158 , N'Cong nghe thong tin')
INSERT INTO CTDT_NAMVH(MaCTDT_4592, TenCTDT_4592, SoTinChiCan_4592, KhoavienQL_4592)
VALUES ('VietNhat', N'VietNhat',165 , N'Cong nghe thong tin')

INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT1130',N'Tinhocdaicuong',4,45,15,15,0.6,'KTMT')
INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT2000',N'NhapmonCNTT',4,30,15,30,0.6,'KTMT')
INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT3040',N'Kythuatlaptrinh',4,45,15,15,0.6,'KHMT')
INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT3090',N'Cosodulieu',3,30,15,15,0.6,'KHMT')
INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT3100',N'laptrinhHDT',3,30,15,0,0.6,'KHMT')
INSERT INTO	dbo.HOCPHAN_NAMVH(MaHP_4592,TenHP_4592,SOTCTL_4592,SoGioLT_4592,SoGioBT_4592,SoGioTH_4592,HeSoDiemCK,MACTDT_4592)
 VALUES('IT4408',N'ThietkevaLTWeb',3,30,15,15,0.6,'KHMT')


INSERT INTO dbo.DANGKY_NAMVH
(
    MaSV_4592,
    MaHP_4592,
    KYHOC_4592,
    DIEMQT_4592,
    DIEMCK_4592
)
VALUES
(   '',  -- MaSV_4592 - varchar(5)
    '',  -- MaHP_4592 - varchar(6)
    '',  -- KYHOC_4592 - varchar(5)
    0.0, -- DIEMQT_4592 - real
    0.0  -- DIEMCK_4592 - real
    )
    )
 

INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT1130','20212',7,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT2000','20192',9,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT3040','20212',5,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT3090','20212',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT3100','20191',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV001','IT4408','20191',4,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT1130','20192',7,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT2000','20202',9,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT3040','20191',5,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT3090','20192',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT3100','20201',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV002','IT4408','20201',4,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT1130','20192',7,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT2000','20202',9,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT3040','20191',5,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT3090','20192',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT3100','20202',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV003','IT4408','20212',4,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT1130','20202',7,5)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT2000','20212',9,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT3040','20191',5,8)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT3090','20212',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT3100','20211',5,6)
INSERT INTO dbo.DANGKY_NAMVH(MaSV_4592,MaHP_4592,KYHOC_4592,DIEMQT_4592,DIEMCK_4592) 
VALUES('SV004','IT4408','20201',4,5)



--4.1
SELECT CTDT.MaCTDT_4592, CTDT.TenCTDT_4592
FROM CTDT_NAMVH AS CTDT
WHERE CTDT.KhoavienQL_4592 =  N'Cong nghe thong tin'


--4.2
SELECT HP.TenHP_4592, HP.SOTCTL_4592,
(HP.SoGioLT_4592 + HP.SoGioBT_4592 + 1.5*HP.SoGioTH_4592)/15 AS [SOTCHP]
FROM HOCPHAN_NAMVH AS HP
WHERE MaCTDT_4592 = 'KHMT'

--4.3
SELECT HP.MaHP_4592, HP.TenHP_4592, COUNT(DK.MaHP_4592) AS [SO SINH VIEN], AVG(DIEMQT_4592) AS [TB]
FROM HOCPHAN_NAMVH AS HP
INNER JOIN DANGKY_NAMVH AS DK ON HP.MaHP_4592 = DK.MaHP_4592
GROUP BY HP.MaHP_4592, HP.TenHP_4592
HAVING AVG(DIEMQT_4592) >= 7


--4.4 
SELECT SV.MaSV_4592, SV.HoTen_SV_4592, HP.TenHP_4592,
(HP.HeSoDiemCK*DK.DIEMCK_4592 + (1-HP.HeSoDiemCK)*DK.DIEMCK_4592) AS [KQ]
FROM SINHVIEN_NAMVH AS SV, DANGKY_NAMVH AS DK, HOCPHAN_NAMVH AS HP
WHERE SV.MaSV_4592 = DK.MaSV_4592  AND HP.MaHP_4592 = DK.MaHP_4592 AND DK.KYHOC_4592 = '20212'

--4.5
SELECT HP.MaHP_4592, HP.TenHP_4592
FROM dbo.HOCPHAN_NAMVH AS HP
WHERE HP.MaHP_4592 NOT IN (
SELECT MaHP_4592
FROM dbo.DANGKY_NAMVH
WHERE KYHOC_4592 = '20212'
)